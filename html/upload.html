<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Subir Recibos</title>
  <link rel="stylesheet" href="../upload.css">
</head>
<body>
  <header class="header">
    <div class="logo">
      <a href="Maensa.html">
        <img src="../fotos/logo.jpg" alt="Logo Maensa" />
      </a>
    </div>
    <nav class="inicio_de_sesion">
      <ul>
        <li>
          <a href="#" id="btn-login" onclick="mostrarLogin(); return false;">Iniciar sesión</a>
        </li>
        <li>
          <a href="#" id="btn-register" onclick="mostrarRegistro(); return false;">Registrarse</a>
        </li>
        <li class="menu-usuario hidden" id="menu-usuario-li">
          <a href="#" id="btn-usuario" onclick="toggleMenuUsuario(); return false;">
            <span class="nombre-usuario"></span>
            <img src="../fotos/usuario.png" alt="Usuario" class="icono-usuario"/>
          </a>
          <div class="menu-desplegable">
            <a href="cuenta.html">Cuenta</a>
            <a href="planel.html">Planes</a>
            <a href="upload.html">Subir imágenes</a>
            <a href="#" onclick="cerrarSesion(); return false;">Cerrar sesión</a>
          </div>
        </li>
      </ul>
    </nav>
  </header>

  <header><h1>Subir archivos</h1></header>

<main class="main upload-container">
    <!-- 1) Estado del plan y fotos restantes -->
    <div class="status-plan">
      <strong>Plan: </strong><span id="plan-name">—</span><br>
      <strong>Fotos restantes hoy: </strong><span id="plan-remaining">—</span>
    </div>

    <!-- 2) Zona de drop / click -->
    <section id="upload-section">
      <label for="file-input" class="dropzone">
        <span class="dropzone-title">Arrastra archivos acá</span><br>
        <span class="dropzone-subtitle">Haz click si no funciona</span>
        <input type="file"
               id="file-input"
               multiple
               accept="image/*,application/pdf" />
      </label>

      <div id="previews"></div>
      <button id="btn-process" disabled>Procesar recibos</button>
    </section>

    <!-- 3) Cuenta atrás hasta reinicio -->
    <div class="countdown-container">
      <small>Se restablecen en: <span id="countdown">--:--:--</span></small>
    </div>
  </main>

<footer>
    <p>© 2025 Maensa. Todos los derechos reservados.</p>
  </footer>

<script src="../js/planes.js"></script>
  <script>
  (function(){
    // Lógica de sesión/navbar
    function loginExitoso(usuario) {
      document.getElementById("btn-login").style.display    = "none";
      document.getElementById("btn-register").style.display = "none";
      const menuLi = document.getElementById("menu-usuario-li");
      menuLi.classList.remove("hidden");
      document.querySelector(".nombre-usuario").textContent =
        `${usuario.nombre} ${usuario.apellido}`;
    }
    function mostrarLogin()    { /* abre modal login */ }
    function mostrarRegistro() { /* abre modal registro */ }
    function cerrarSesion()    { localStorage.removeItem("usuario"); window.location.href="Maensa.html"; }

    function toggleMenuUsuario(){
      const menuLi = document.getElementById("menu-usuario-li");
      menuLi.classList.toggle("activo");
      menuLi.classList.toggle("hidden");
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      // Autologin
      const raw = localStorage.getItem("usuario");
      if(raw) try{ loginExitoso(JSON.parse(raw)); }catch{}
      document.getElementById("btn-usuario")
        .addEventListener("click",e=>{e.preventDefault(); toggleMenuUsuario();});
      // click fuera cierra menú
      document.addEventListener("click", e=>{
        const menuLi = document.getElementById("menu-usuario-li");
        const btn    = document.getElementById("btn-usuario");
        if(menuLi && btn && !menuLi.contains(e.target) && e.target!==btn){
          menuLi.classList.add("hidden");
          menuLi.classList.remove("activo");
        }
      });
    });

    // Lógica de subida y plan
    const limits = { gratis:20, basico:20, intermedio:50, pro:100, ilimitado:Infinity };
    const user  = JSON.parse(localStorage.getItem("usuario")||"{}");
    const plan  = user.plan || "gratis";
    const limit = limits[plan] ?? 20;
    const key   = "uploadsUsed";
    const today = new Date().toISOString().slice(0,10);

    function getUsed(){
      const o = JSON.parse(localStorage.getItem(key)||"{}");
      return (o.date===today)?o.count:0;
    }
    function setUsed(n){
      localStorage.setItem(key, JSON.stringify({ date:today, count:n }));
    }

    const planNameEl  = document.getElementById("plan-name");
    const remEl       = document.getElementById("plan-remaining");
    const input       = document.getElementById("file-input");
    const previews    = document.getElementById("previews");
    const btn         = document.getElementById("btn-process");
    const cdEl        = document.getElementById("countdown");

    function updatePlan(){
      const used = getUsed();
      const rem = limit===Infinity? "∞" : Math.max(0, limit-used);
      planNameEl.textContent = plan.charAt(0).toUpperCase()+plan.slice(1);
      remEl.textContent      = rem + (limit===Infinity? "" : ` / ${limit}`);
    }
    updatePlan();

    input.addEventListener("change", ()=>{
      previews.innerHTML="";
      const used = getUsed(), rem = Math.max(0, limit-used);
      const files = Array.from(input.files).slice(0, rem);
      files.forEach(f=>{
        const d=document.createElement("div");
        d.className="preview-item";
        d.textContent=f.name;
        previews.appendChild(d);
      });
      if(input.files.length>rem) alert(`Solo puedes subir ${rem} fotos hoy.`);
      btn.disabled = files.length===0;
      updatePlan();
    });

    btn.addEventListener("click",async ()=>{
      const files = Array.from(input.files);
      if(!files.length) return;
      const form = new FormData();
      files.forEach(f=>form.append("files",f));
      btn.textContent="Procesando…"; btn.disabled=true;
      try{
        const res = await fetch("https://maensa.onrender.com/api/receipt-parser",{
          method:"POST", body: form
        });
        const json = await res.json();
        localStorage.setItem("receiptResult", JSON.stringify(json));
        setUsed(getUsed()+files.length);
        location.href="results.html";
      }catch(e){
        alert("Error: "+e.message);
        btn.textContent="Procesar recibos"; btn.disabled=false;
      }
    });

    // Countdown a medianoche
    function updateCountdown(){
      const now=new Date();
      const tom=new Date(now);
      tom.setDate(now.getDate()+1); tom.setHours(0,0,0,0);
      const diff=tom-now;
      const hh=String(Math.floor(diff/3600000)).padStart(2,"0");
      const mm=String(Math.floor((diff%3600000)/60000)).padStart(2,"0");
      const ss=String(Math.floor((diff%60000)/1000)).padStart(2,"0");
      cdEl.textContent=`${hh}:${mm}:${ss}`;
    }
    setInterval(updateCountdown,1000);
    updateCountdown();

  })();
  </script>
</body>
</html>